name: armv8打包

on:
  repository_dispatch:
    types: [db]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'db'
        required: false
        default: 'false'
  schedule:
    - cron: 30 23 * * *

env:
  kREPO_URL: https://github.com/coolsnowwolf/lede #开发版仓库
  wREPO_URL: https://github.com/coolsnowwolf/openwrt #稳定版仓库
  kREPO_BRANCH: master #开发版分支
  wREPO_BRANCH: lede-17.01 #稳定版分支
  UPLOAD_BIN_DIR: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:

  kbuild+0: #开发+0版
    runs-on: ubuntu-18.04
    steps:    
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #初始化环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # 获取更新信息
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $kREPO_URL -b $kREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="编译前的最后一次[➦主源码](https://github.com/coolsnowwolf/lede)更新记录:<br/>更新人: %an<br/>更新时间: %cd<br/>更新内容: %s<br/>哈希值: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Y年%m月%d日%H时%M分")" >> $GITHUB_ENV
    - name: Build firmware #打包
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/公告/img+0.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8开发版/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./mk_beikeyun_opimg.sh
        sudo ./mk_l1pro_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #上传artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: k+0
        path: ${{ env.FIRMWARE }}
    - name: Create release #发布
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} 🚀 armv8开发版 | 自动编译
        allowUpdates: true
        tag: armv8开发版
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}


  kbuild+: #开发+版
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #初始化环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # 获取更新信息
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $kREPO_URL -b $kREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        sed -i 's/#src-git helloworld/src-git helloworld/g' ./feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="编译前的最后一次[➦主源码](https://github.com/coolsnowwolf/lede)更新记录:<br/>更新人: %an<br/>更新时间: %cd<br/>更新内容: %s<br/>哈希值: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Y年%m月%d日%H时%M分")" >> $GITHUB_ENV
    - name: Build firmware #打包
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/公告/img+.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8开发版/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #上传artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: k+
        path: ${{ env.FIRMWARE }}
    - name: Create release #发布
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} 🚀 armv8开发版 | 自动编译
        allowUpdates: true
        tag: armv8开发版
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}


  wbuild+0: #稳定+0版
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #初始化环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # 获取更新信息
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $wREPO_URL -b $wREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="编译前的最后一次[➦主源码](https://github.com/coolsnowwolf/lede)更新记录:<br/>更新人: %an<br/>更新时间: %cd<br/>更新内容: %s<br/>哈希值: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Y年%m月%d日%H时%M分")" >> $GITHUB_ENV
    - name: Build firmware #打包
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/公告/img+0.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8稳定版/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./mk_beikeyun_opimg.sh
        sudo ./mk_l1pro_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #上传artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: w+0
        path: ${{ env.FIRMWARE }}
    - name: Create release #发布
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} 🚀 armv8稳定版 | 自动编译
        allowUpdates: true
        tag: armv8稳定版
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}


  wbuild+: #稳定+版
    runs-on: ubuntu-18.04
    steps:
    - name: Checkout
      uses: actions/checkout@main
    - name: Initialization environment #初始化环境
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
    - name: Clone source code # 获取更新信息
      id: source
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $wREPO_URL -b $wREPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        useVersionInfo=$(git show -s --date=short --format="编译前的最后一次[➦主源码](https://github.com/coolsnowwolf/lede)更新记录:<br/>更新人: %an<br/>更新时间: %cd<br/>更新内容: %s<br/>哈希值: %H")
        echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
        echo "DATE=$(date "+%Y年%m月%d日%H时%M分")" >> $GITHUB_ENV
    - name: Build firmware #打包
      id: build
      run: |
        cd /opt
        sudo wget https://github.com/bin20088/Bin/releases/download/公告/img+.tar
        sudo tar xvf *.tar
        sudo xz -d *.img.xz
        sudo tar zxvf *.tar.gz
        sudo mkdir imgs
        sudo mv *.img imgs
        cd /opt/openwrt
        sudo wget https://github.com/bin20088/Bin/releases/download/armv8稳定版/openwrt-armvirt-64-default-rootfs.tar.gz
        sudo ./mk_s905x3_opimg.sh
        sudo ./mk_n1_opimg.sh
        sudo ./n1-to-vplus.sh
        cd /opt/openwrt/tmp
        echo "::set-output name=status::success"
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
    - name: Upload bin directory #上传artifact
      uses: actions/upload-artifact@main
      if: steps.build.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
      with:
        name: w+
        path: ${{ env.FIRMWARE }}
    - name: Create release #发布
      uses: ncipollo/release-action@v1
      if: env.UPLOAD_RELEASE == 'true' && steps.build.outputs.status == 'success' && !cancelled()
      with:
        name: ${{ env.DATE }} 🚀 armv8稳定版 | 自动编译
        allowUpdates: true
        tag: armv8稳定版
        commit: master
        token: ${{ secrets.RELEASES_TOKEN }}
        body: |
          ${{ env.useVersionInfo }}
        artifacts: ${{ env.FIRMWARE }}
